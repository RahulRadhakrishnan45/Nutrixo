<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-color: #dee2e6;
      --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #f5f5f7; color: #333; line-height: 1.6; }
    .container { width: 95%; max-width: 1400px; margin: auto; padding: 20px; }

    .dashboard-title { font-size: 26px; font-weight: 700; margin-bottom: 20px; }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    .card-header { color: #6c757d; font-size: 14px; font-weight: 600; margin-bottom: 10px; }
    .card-title { font-size: 28px; font-weight: 700; }

    .filter-group { display: flex; gap: 10px; }
    .filter-btn {
      padding: 6px 16px; border-radius: 20px;
      border: 1px solid var(--border-color); background: white;
      cursor: pointer; font-size: 14px; transition: 0.2s;
    }

    .filter-btn.active { background: var(--primary-color); color: white; }

    .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); }

    .large-chart-container {
       height: 500px;
       width: 100%;
      }
    
    #main-sales-chart{
      width: 100% !important;
    }

    .recent-orders { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; border-bottom: 1px solid var(--border-color); }
    th { font-size: 14px; color: #6c757d; }

    .top-lists-container { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap: 20px; }
    .top-list-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); }
    .top-list-title { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
    .top-list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }

    /* Center align Recent Orders table columns */
    .recent-orders table th,
    .recent-orders table td {
        text-align: center;
        vertical-align: middle;
    }

  </style>
</head>

<body>
  <div class="container">
    <h1 class="dashboard-title">Admin Dashboard</h1>

    <!-- STAT CARDS -->
    <div class="cards-container">
      <div class="card">
        <div class="card-header">Total Sales</div>
        <div class="card-title">₹<span id="total-sales">0</span></div>
      </div>

      <div class="card">
        <div class="card-header">Customers</div>
        <div class="card-title"><span id="total-customers">0</span></div>
      </div>

      <div class="card">
        <div class="card-header">Orders</div>
        <div class="card-title"><span id="total-orders">0</span></div>
      </div>
    </div>

    <!-- MAIN SALES CHART -->
    <div class="chart-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="chart-title">Sales Overview</h2>

        <div class="filter-group">
          <button class="filter-btn" data-period="daily">Daily</button>
          <button class="filter-btn" data-period="weekly">Weekly</button>
          <button class="filter-btn active" data-period="monthly">Monthly</button>
          <button class="filter-btn" data-period="yearly">Yearly</button>
        </div>
      </div>

      <div class="large-chart-container">
        <canvas id="main-sales-chart"></canvas>
      </div>
    </div>

    <!-- RECENT ORDERS -->
    <div class="recent-orders mt-5">
      <h2 style="font-size:18px; font-weight:600; margin-bottom:10px;">Recent Orders</h2>
      <table>
        <thead>
          <tr>
            <th>Order Id</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="recent-orders-table"></tbody>
      </table>
    </div>

    <!-- TOP LIST CARDS -->
    <div class="top-lists-container">

      <div class="top-list-card">
        <h3 class="top-list-title">Best Selling Products (Top 10)</h3>
        <ul id="top-products-list"></ul>
      </div>

      <div class="top-list-card">
        <h3 class="top-list-title">Best Selling Categories (Top 10)</h3>
        <ul id="top-categories-list"></ul>
      </div>

      <div class="top-list-card">
        <h3 class="top-list-title">Best Selling Brands (Top 10)</h3>
        <ul id="top-brands-list"></ul>
      </div>

    </div>
    <script>
      function formatCurrency(num) {
        return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(num);
      }

      function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString("en-IN");
      }

      async function fetchDashboard(period = "monthly") {
        const res = await fetch(`/admin/dashboard-details?timeFilter=${period}`);
        return res.json();
      }

      function populateRecentOrders(list) {
        const tbody = document.getElementById("recent-orders-table");
        tbody.innerHTML = "";

        list.forEach(order => {
          tbody.innerHTML += `
            <tr>
              <td style="color: #4361ee; font-weight: 600;">${order.orderNumber || "N/A"}</td>
              <td>${order.user?.name || "Unknown"}</td>
              <td>${formatDate(order.createdAt)}</td>
              <td>${formatCurrency(order.totalAmount)}</td>
              <td>${order.items[0]?.status}</td>
            </tr>
          `;
        });
      }

      function populateTopLists(products, categories, brands) {
        const prod = document.getElementById("top-products-list");
        const cat = document.getElementById("top-categories-list");
        const br = document.getElementById("top-brands-list");

        prod.innerHTML = "";
        cat.innerHTML = "";
        br.innerHTML = "";

        products.forEach(p => {
          prod.innerHTML += `
            <li class="top-list-item">
              <span>${p.title || "Unnamed Product"}</span>
              <span>${p.totalQty}</span>
            </li>
          `;
        });

        categories.forEach(c => {
          cat.innerHTML += `
            <li class="top-list-item">
              <span>${c.name || "Unknown Category"}</span>
              <span>${c.totalQty}</span>
            </li>
          `;
        });

        brands.forEach(b => {
          br.innerHTML += `
            <li class="top-list-item">
              <span>${b.name || "Unknown Brand"}</span>
              <span>${b.totalQty}</span>
            </li>
          `;
        });
      }

      let mainChart;
      function updateMainChart(labels, data) {
          if (mainChart) mainChart.destroy();
          const ctx = document.getElementById("main-sales-chart").getContext("2d");
          const maxValue = Math.max(...data);
          const suggestedMax = maxValue === 0 ? 10 : maxValue * 1.3;

          mainChart = new Chart(ctx, {
              type: "line",
              data: {
                  labels,
                  datasets: [{
                      label: "Sales (₹)",
                      data,
                      borderColor: "#4361ee",
                      backgroundColor: "rgba(67,97,238,0.15)",
                      tension: 0.4,
                      fill: true,
                      pointRadius: 4,
                      pointBackgroundColor: "#4361ee",
                      pointBorderWidth: 1,
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  
                  scales: {
                      y: {
                          beginAtZero: true,
                          suggestedMin: 0,
                          suggestedMax: suggestedMax,
                          grid: {
                              color: "#e5e5e5"
                          },
                          ticks: {
                              callback: value => "₹" + value
                          }
                      },
                      x: {
                          grid: { display: false },
                          ticks:{
                            autoSkip:false,
                            maxRotation:45,
                            minRotation:45
                          }
                      }
                  },

                  plugins: {
                      legend: { display: true }
                  }
              }
          });
      }
      async function init(period = "monthly") {
        const data = await fetchDashboard(period);

        document.getElementById("total-sales").textContent =
          data.totalSales.toLocaleString("en-IN");
        document.getElementById("total-customers").textContent = data.customers;
        document.getElementById("total-orders").textContent = data.totalOrders;

        updateMainChart(data.timeSeriesLabels, data.timeSeriesData);

        populateRecentOrders(data.recentOrders);
        populateTopLists(data.topProducts, data.topCategories, data.topBrands);
      }

      document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          init(btn.dataset.period);
        });
      });

      init();
    </script>
  </body>
</html>

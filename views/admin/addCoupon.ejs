<div class="p-6">
  <!-- Card -->
  <div class="bg-white shadow-md rounded-lg p-6">

    <!-- Back Link -->
    <a href="/admin/coupons" class="text-sm text-blue-600 hover:underline mb-2 inline-block">
      ← Back to Coupons
    </a>    

    <!-- Title -->
    <h1 class="text-lg font-semibold mt-12 mb-6 text-gray-800">Create New Coupon</h1>

    <!-- Form -->
    <form id="addCouponForm" action="#" method="POST" novalidate class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Left Section -->
      <div class="space-y-5">

        <!-- Coupon Code -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code *</label>
          <input type="text" name="code"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 codeError errorText"></div>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
          <textarea name="description" rows="3"
                    class="w-full border border-gray-300 rounded-md px-4 py-2 resize-none focus:ring-2 focus:ring-black focus:outline-none"></textarea>
          <div class="text-red-500 text-sm mt-1 descriptionError errorText"></div>
        </div>

        <!-- Usage Limit -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Usage Limit</label>
          <input type="number" name="usageLimit" placeholder="leave empty for unlimited"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 usageLimitError errorText"></div>
        </div>

        <!-- Active -->
        <div class="flex items-center space-x-3 mt-4">
          <input type="checkbox" name="isActive" id="isActive" checked
                 class="w-5 h-5 accent-black">
          <label for="isActive" class="text-gray-700 font-medium">Active</label>
        </div>
      </div>

      <!-- Right Section -->
      <div class="space-y-5">

        <!-- Discount Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Discount Type *</label>
          <select name="discountType"
                  class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none">
            <option value="" disabled selected>Select type</option>
            <option value="percentage">Percentage</option>
            <option value="fixed">Fixed</option>
          </select>
          <div class="text-red-500 text-sm mt-1 discountTypeError errorText"></div>
        </div>

        <!-- Discount Amount -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Discount Amount *</label>
          <input type="number" name="discountAmount"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 discountError errorText"></div>
        </div>

        <!-- Minimum Purchase -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Purchase Amount</label>
          <input type="number" name="minimumPurchase"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 minPurchaseError errorText"></div>
        </div>

        <!-- Date Fields -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valid From *</label>
            <input type="date" name="startDate"
                   class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
            <div class="text-red-500 text-sm mt-1 dateError errorText"></div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valid To *</label>
            <input type="date" name="endDate"
                   class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
            <div class="text-red-500 text-sm mt-1 dateError errorText"></div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="md:col-span-2 flex items-center justify-start space-x-4 mt-6">
        <button type="submit"
                class="bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition">
          Create Coupon
        </button>
        <button type="reset"
                class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300 transition">
          Reset
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("addCouponForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    let isValid = true;

    // Clear previous errors
    document.querySelectorAll(".errorText").forEach(div => div.textContent = "");

    // Form fields
    const code = form.querySelector('input[name="code"]');
    const description = form.querySelector('textarea[name="description"]');
    const discountType = form.querySelector('select[name="discountType"]');
    const discountAmount = form.querySelector('input[name="discountAmount"]');
    const minimumPurchase = form.querySelector('input[name="minimumPurchase"]');
    const startDate = form.querySelector('input[name="startDate"]');
    const endDate = form.querySelector('input[name="endDate"]');

    // Error divs
    const codeError = document.querySelector('.codeError');
    const descriptionError = document.querySelector('.descriptionError');
    const discountTypeError = document.querySelector('.discountTypeError');
    const discountError = document.querySelector('.discountError');
    const minPurchaseError = document.querySelector('.minPurchaseError');
    const dateError = document.querySelector('.dateError');

    // Values
    const discountValue = parseFloat(discountAmount.value) || 0;
    const minPurchaseValue = parseFloat(minimumPurchase.value) || 0;
    const start = new Date(startDate.value);
    const end = new Date(endDate.value);

    // -------- Validation --------
    if (!code.value.trim()) { codeError.textContent = "Coupon code is required"; isValid = false; }
    if (!description.value.trim()) { descriptionError.textContent = "Description is required"; isValid = false; }
    if (!discountType.value) { discountTypeError.textContent = "Select a discount type"; isValid = false; }
    if (discountValue <= 0) { discountError.textContent = "Enter a valid discount amount"; isValid = false; }
    if (discountType.value === "percentage" && discountValue > 100) {
      discountError.textContent = "Percentage discount cannot exceed 100%"; isValid = false;
    }
    if (minPurchaseValue > 0 && discountType.value === "fixed" && discountValue >= minPurchaseValue) {
      minPurchaseError.textContent = "Discount cannot exceed or equal minimum purchase amount"; isValid = false;
    }
    if (discountType.value === "fixed" && discountValue > 10000) {
      discountError.textContent = "Fixed discount cannot exceed ₹10,000";
      isValid = false;
    }
    if (!startDate.value) { dateError.textContent = "Start date is required"; isValid = false; }
    if (!endDate.value) { dateError.textContent = "End date is required"; isValid = false; }
    if (startDate.value && endDate.value && start > end) {
      dateError.textContent = "End date must be after start date"; isValid = false;
    }

    // SweetAlert error if invalid
    if (!isValid) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please fix the highlighted issues before submitting.",
      });
      return;
    }

    // Show loading alert
    Swal.fire({
      title: "Creating Coupon...",
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false,
    });

    // Submit via AJAX
    try {
      const formData = new URLSearchParams(new FormData(form));
      const response = await fetch('/admin/coupons', {
        method: "POST",
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: formData,
      });
      Swal.close();

      const data = await response.json();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Coupon Created!",
          text: data.message || "Coupon has been added successfully.",
          timer: 1800,
          showConfirmButton: false,
        }).then(() => {
          window.location.href = "/admin/coupons";
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: data.message || "Something went wrong while creating the coupon.",
        });
      }
    } catch (err) {
      Swal.close();
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Could not connect to server. Please try again later.",
      });
    }
  });
});
</script>

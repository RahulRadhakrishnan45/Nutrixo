<div class="p-6">
  <!-- Card -->
  <div class="bg-white shadow-md rounded-lg p-6">

    <!-- Back Link -->
    <a href="/admin/coupons" class="text-sm text-blue-600 hover:underline mb-2 inline-block">
      ‚Üê Back to Coupons
    </a>    

    <!-- Title -->
    <h1 class="text-lg font-semibold mt-12 mb-6 text-gray-800">Create New Coupon</h1>

    <!-- Form -->
    <form id="addCouponForm" action="#" method="POST" novalidate class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Left Section -->
      <div class="space-y-5">

        <!-- Coupon Code -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code *</label>
          <input type="text" name="code"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 codeError errorText"></div>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
          <textarea name="description" rows="3"
                    class="w-full border border-gray-300 rounded-md px-4 py-2 resize-none focus:ring-2 focus:ring-black focus:outline-none"></textarea>
          <div class="text-red-500 text-sm mt-1 descriptionError errorText"></div>
        </div>

        <!-- Usage Limit -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Usage Limit</label>
          <input type="number" name="usageLimit" placeholder="leave empty for unlimited"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 usageLimitError errorText"></div>
        </div>

        <!-- Active -->
        <div class="flex items-center space-x-3 mt-4">
          <input type="checkbox" name="isActive" id="isActive" checked
                 class="w-5 h-5 accent-black">
          <label for="isActive" class="text-gray-700 font-medium">Active</label>
        </div>
      </div>

      <!-- Right Section -->
      <div class="space-y-5">

        <!-- Discount Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Discount Type *</label>
          <select name="discountType"
                  class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none">
            <option value="" disabled selected>Select type</option>
            <option value="percentage">Percentage</option>
            <option value="fixed">Fixed</option>
          </select>
          <div class="text-red-500 text-sm mt-1 discountTypeError errorText"></div>
        </div>

        <!-- Discount Amount -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Discount Amount *</label>
          <input type="number" name="discountAmount"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 discountError errorText"></div>
        </div>

        <!-- Minimum Purchase -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Purchase Amount</label>
          <input type="number" name="minimumPurchase"
                 class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 minPurchaseError errorText"></div>
        </div>

        <!-- Date Fields -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valid From *</label>
            <input type="date" name="startDate"
                   class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
            <div class="text-red-500 text-sm mt-1 dateError errorText"></div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Valid To *</label>
            <input type="date" name="endDate"
                   class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
            <div class="text-red-500 text-sm mt-1 dateError errorText"></div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="md:col-span-2 flex items-center justify-start space-x-4 mt-6">
        <button type="submit"
                class="bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition">
          Create Coupon
        </button>
        <button type="reset"
                class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300 transition">
          Reset
        </button>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>

toastr.options = {
  closeButton: true,
  progressBar: true,
  positionClass: "toast-bottom-right",
  timeOut: 2000
};

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("addCouponForm");

  // === Fields ===
  const code = form.querySelector('input[name="code"]');
  const description = form.querySelector('textarea[name="description"]');
  const discountType = form.querySelector('select[name="discountType"]');
  const discountAmount = form.querySelector('input[name="discountAmount"]');
  const minimumPurchase = form.querySelector('input[name="minimumPurchase"]');
  const startDate = form.querySelector('input[name="startDate"]');
  const endDate = form.querySelector('input[name="endDate"]');

  // === Error fields ===
  const codeError = document.querySelector('.codeError');
  const descriptionError = document.querySelector('.descriptionError');
  const discountTypeError = document.querySelector('.discountTypeError');
  const discountError = document.querySelector('.discountError');
  const minPurchaseError = document.querySelector('.minPurchaseError');
  const dateErrors = document.querySelectorAll('.dateError');

  // LIVE VALIDATION
  code.addEventListener("input", () => {
    const val = code.value.trim();
    const regex = /^(?=(.*[A-Za-z]){3,})(?=.*\d).+$/; 

    if (!val) codeError.textContent = "Coupon code is required";
    else if (!regex.test(val)) codeError.textContent = "Must contain 3 letters and 1 number";
    else codeError.textContent = "";
  });

  description.addEventListener("input", () => {
    const raw = description.value || "";
    const totalChars = raw.replace(/\s+/g, "").length; 

    if (totalChars < 10) {
      descriptionError.textContent = 'Description must be at least 10 characters';
    } else {
      descriptionError.textContent = "";
    }
  });

  // --- Discount Validation ---
  function validateDiscount() {
    const type = discountType.value;
    const val = parseFloat(discountAmount.value) || 0;
    const minVal = parseFloat(minimumPurchase.value) || 0;

    discountError.textContent = "";
    minPurchaseError.textContent = "";

    if (!type) {
      discountTypeError.textContent = "Select a discount type";
      return;
    } else {
      discountTypeError.textContent = "";
    }

    // percentage 1 - 90
    if (type === "percentage") {
      if (val < 1 || val > 90) {
        discountError.textContent = "Percentage must be between 1% - 90%";
        return;
      }
    }

    // fixed 1 - 10000
    if (type === "fixed") {
      if (val < 1 || val > 10000) {
        discountError.textContent = "Fixed discount must be 1 - 10,000";
        return;
      }

      if (minVal > 0 && val >= minVal) {
        minPurchaseError.textContent = "Discount cannot be ‚â• minimum purchase";
        return;
      }
    }
  }

  discountType.addEventListener("change", validateDiscount);
  discountAmount.addEventListener("input", validateDiscount);
  minimumPurchase.addEventListener("input", validateDiscount);

  // --- Date validation ---
  function validateDates() {
    dateErrors.forEach(el => el.textContent = "");

    if (!startDate.value) {
      dateErrors.forEach(el => el.textContent = "Start date is required");
      return;
    }

    if (!endDate.value) {
      dateErrors.forEach(el => el.textContent = "End date is required");
      return;
    }

    if (new Date(startDate.value) > new Date(endDate.value)) {
      dateErrors.forEach(el => el.textContent = "End date must be after start date");
    }
  }

  startDate.addEventListener("change", validateDates);
  endDate.addEventListener("change", validateDates);

  // üî• SUBMIT HANDLER
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Trigger validation before submit
    code.dispatchEvent(new Event("input"));
    description.dispatchEvent(new Event("input"));
    validateDiscount();
    validateDates();

    let isValid = true;
    document.querySelectorAll(".errorText").forEach(err => {
      if (err.textContent.trim() !== "") isValid = false;
    });

    if (!isValid) {
      toastr.error("Please fix the highlighted issues.");
      return;
    }

    try {
      
      const formData = new URLSearchParams(new FormData(form));

      const response = await fetch("/admin/coupons", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData,
      });

      const data = await response.json();

      Swal.close(); 

      if (!data.success) {
        toastr.error(data.message || "Error creating coupon.");
        return;
      }

      // ‚úÖ SUCCESS ‚Üí SHOW SWEETALERT
      Swal.fire({
        icon: "success",
        title: "Coupon Created!",
        text: data.message || "Coupon has been created successfully.",
        timer: 1800,
        showConfirmButton: false
      }).then(() => {
        window.location.href = "/admin/coupons";
      });

    } catch (err) {
      Swal.close();
      toastr.error("Server error. Try again later.");
    }
  });

});
</script>

<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">

<div class="p-6">
  <div class="bg-white shadow-md rounded-lg p-6">

    <!-- Back Link -->
    <a href="/admin/offers" class="text-sm text-blue-600 hover:underline mb-2 inline-block">
      ← Back to Offers
    </a>

    <!-- Title -->
    <h1 class="text-lg font-semibold mt-12 mb-6 text-gray-800">Add New Offer</h1>

    <!-- Form -->
    <form id="addOfferForm" method="POST" action="/admin/offers" novalidate class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- LEFT COLUMN -->
      <div class="space-y-5">

        <!-- Offer Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Offer Name *</label>
          <input type="text" name="offerName" placeholder="e.g., Winter Blast Sale"
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 offerNameError errorText"></div>
        </div>

        <!-- Discount Percentage -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Discount Percentage (%) *</label>
          <input type="number" name="discountPercentage" min="1" max="90" placeholder="e.g., 15"
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 discountError errorText"></div>
        </div>

        <!-- Valid From -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Valid From *</label>
          <input type="date" name="validFrom"
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 validFromError errorText"></div>
        </div>

        <!-- Valid To -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Valid To *</label>
          <input type="date" name="validTo"
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring-2 focus:ring-black focus:outline-none" />
          <div class="text-red-500 text-sm mt-1 validToError errorText"></div>
        </div>

        <!-- Active Checkbox -->
        <div class="flex items-center space-x-3 mt-4">
          <input type="checkbox" name="isActive" id="isActive" checked class="w-5 h-5 accent-black">
          <label for="isActive" class="text-gray-700 font-medium">Active</label>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="space-y-5">

        <!-- Apply to Categories -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Apply to Categories</label>
          <select id="categorySelect" name="category" multiple>
            <% if (categories && categories.length > 0) { %>
              <% categories.forEach(cat => { %>
                <option value="<%= cat._id %>"><%= cat.name %></option>
              <% }) %>
            <% } else { %>
              <option disabled>No categories available</option>
            <% } %>
          </select>
        </div>

        <!-- Apply to Products (showing variants) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Apply to Products</label>
          <select id="productSelect" name="product" multiple>
            <% if (products && products.length > 0) { %>
              <% products.forEach(prod => { %>
                <option value="<%= prod.productId %>"><%= prod.title %></option>
              <% }) %>
            <% } else { %>
              <option disabled>No products available</option>
            <% } %>
          </select>
        </div>

        <!-- Apply to Brands -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Apply to Brands</label>
          <select id="brandSelect" name="brand" multiple>
            <% if (brands && brands.length > 0) { %>
              <% brands.forEach(brand => { %>
                <option value="<%= brand._id %>"><%= brand.name %></option>
              <% }) %>
            <% } else { %>
              <option disabled>No brands available</option>
            <% } %>
          </select>
        </div>
      </div>

      <!-- BUTTONS -->
      <div class="md:col-span-2 flex items-center space-x-4 mt-6">
        <button type="submit"
          class="bg-black text-white px-6 py-2 rounded-md hover:bg-gray-800 transition">
          Add Offer
        </button>
        <button type="reset"
          class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300 transition">
          Reset
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Initialize Tom Select (multi-selects)
  new TomSelect("#categorySelect", { plugins: ['remove_button'], create: false });
  new TomSelect("#productSelect", { plugins: ['remove_button'], create: false });
  new TomSelect("#brandSelect", { plugins: ['remove_button'], create: false });

  const form = document.getElementById("addOfferForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    // Reset errors
    document.querySelectorAll(".errorText").forEach(div => div.textContent = "");
    let isValid = true;

    const name = form.offerName.value.trim();
    const discount = parseFloat(form.discountPercentage.value);
    const validFrom = form.validFrom.value;
    const validTo = form.validTo.value;

    // Error divs
    const nameErr = document.querySelector(".offerNameError");
    const discountErr = document.querySelector(".discountError");
    const fromErr = document.querySelector(".validFromError");
    const toErr = document.querySelector(".validToError");

    // Validation
    if (!name) { nameErr.textContent = "Offer name is required."; isValid = false; }
    if (!discount || discount < 1 || discount > 90) { discountErr.textContent = "Discount must be between 1–90%."; isValid = false; }
    if (!validFrom) { fromErr.textContent = "Start date is required."; isValid = false; }
    if (!validTo) { toErr.textContent = "End date is required."; isValid = false; }
    if (validFrom && validTo && new Date(validFrom) > new Date(validTo)) {
      toErr.textContent = "End date must be after start date.";
      isValid = false;
    }

    if (!isValid) {
      Swal.fire({
        icon: "error",
        title: "Validation Error",
        text: "Please fix the highlighted issues before submitting.",
      });
      return;
    }

    Swal.fire({
      title: "Creating Offer...",
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false,
    });

    try {
      const formData = new URLSearchParams(new FormData(form));
      const response = await fetch('/admin/offers', {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData
      });

      const data = await response.json();
      Swal.close();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Offer Created!",
          text: data.message || "Offer has been added successfully.",
          timer: 1800,
          showConfirmButton: false,
        }).then(() => window.location.href = "/admin/offers");
      } else {
        Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong." });
      }
    } catch (err) {
      Swal.close();
      Swal.fire({
        icon: "error",
        title: "Server Error",
        text: "Could not connect to server. Please try again later.",
      });
    }
  });
});
</script>

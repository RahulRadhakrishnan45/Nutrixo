<div class="p-6">
  <!-- Breadcrumb -->
  <nav class="text-sm mb-6 text-gray-500">
    <ol class="flex items-center space-x-2">
      <li><a href="/admin/dashboard" class="hover:underline text-gray-600">Admin</a></li>
      <li>/</li>
      <li class="text-gray-800 font-medium">Customers</li>
    </ol>
  </nav>

  <!-- Heading -->
  <div class="flex justify-between items-center mb-8 mt-10">
    <h1 class="text-xl font-semibold">Customers</h1>
  </div>

  <!-- Top bar -->
  <div class="flex justify-end items-center mb-6 space-x-2">
    <input type="text" id="searchInput" placeholder="Search customers..."
      class="px-3 py-2 border rounded-md w-72 focus:outline-none focus:ring focus:ring-blue-300">
  </div>

  <!-- Customer List -->
  <div class="bg-white shadow-md rounded-lg mt-10 overflow-hidden">
    <table class="w-full text-base text-left text-gray-700">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
          <th class="px-6 py-4">Sno</th>
          <th class="px-6 py-4">Name</th>
          <th class="px-6 py-4">Email</th>
          <th class="px-6 py-4">Mobile</th>
          <th class="px-6 py-4">Status</th>
          <th class="px-6 py-4">Join Date</th>
          <th class="px-6 py-4 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="customerTable">
        <% users.forEach((user, index) => { %>
          <tr class="border-b hover:bg-gray-50">
            <td class="px-6 py-4"><%= index + 1 %></td>
            <td class="px-6 py-4 font-medium"><%= user.name %></td>
            <td class="px-6 py-4"><%= user.email %></td>
            <td class="px-6 py-4"><%= user.mobile || '-' %></td>
            <td class="px-6 py-4">
              <% if (user.is_active) { %>
                <span class="px-2 py-1 text-sm rounded-full bg-green-100 text-green-700">Active</span>
              <% } else { %>
                <span class="px-2 py-1 text-sm rounded-full bg-red-100 text-red-700">Blocked</span>
              <% } %>
            </td>
            <td class="px-6 py-4"><%= user.createdAt.toDateString() %></td>
            <td class="px-6 py-4 text-center">
                <% if (user.is_active) { %>
                    <button 
                        class="toggleBtn bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm"
                        data-id="<%= user._id %>"
                        data-active="true">
                        Block
                    </button>
                <% } else { %>
                    <button 
                        class="toggleBtn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm"
                        data-id="<%= user._id %>"
                        data-active="false">
                        Unblock
                    </button>
                <% } %>
            </td>

          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<%- include('../partials/pagination.ejs',{currentPage, totalPages}) %>

<script>
  // Function to bind toggle button clicks
  function bindToggleButtons() {
    document.querySelectorAll('.toggleBtn').forEach(btn => {
      btn.removeEventListener('click', toggleHandler); // prevent duplicate listeners
      btn.addEventListener('click', toggleHandler);
    });
  }

  // Toggle handler
  async function toggleHandler() {
    const btn = this;
    const userId = btn.dataset.id;
    const isActive = btn.dataset.active === "true";

    const action = isActive ? 'block' : 'unblock'
    const actionText = isActive ? 'This user will be blocked and cannot access the site' : 'This user will be unblocked and regain access to the site'

    const result = await Swal.fire({
      title:`Are you sure you want to ${action} this user ?`,
      text:actionText,
      icon:'warning',
      showCancelButton:true,
      confirmButtonColor:isActive ? '#d33' : '#3085d6',
      cancelButtonColor:'#6c757d',
      confirmButtonText:`Yes, ${action}`
    })

      if(!result.isConfirmed) return
    

    const res = await fetch(`/admin/customers/${userId}/block`, { method: 'PATCH' });
    const data = await res.json();

    if (data.success) {
      if (isActive) {
        btn.textContent = "Unblock";
        btn.classList.remove("bg-red-500", "hover:bg-red-600");
        btn.classList.add("bg-green-500", "hover:bg-green-600");
        btn.dataset.active = "false";
        btn.closest("tr").querySelector("td:nth-child(5)").innerHTML =
          `<span class="px-2 py-1 text-sm rounded-full bg-red-100 text-red-700">Blocked</span>`;
          Swal.fire("Blocked!", "The user has been blocked.", "success");
      } else {
        btn.textContent = "Block";
        btn.classList.remove("bg-green-500", "hover:bg-green-600");
        btn.classList.add("bg-red-500", "hover:bg-red-600");
        btn.dataset.active = "true";
        btn.closest("tr").querySelector("td:nth-child(5)").innerHTML =
          `<span class="px-2 py-1 text-sm rounded-full bg-green-100 text-green-700">Active</span>`;
          Swal.fire("Unblocked!", "The user has been unblocked.", "success");
      }
    } else {
      Swal.fire("Error", "Could not update user status", "error");
    }
  }

  // Initial binding on page load
  bindToggleButtons();

  /////// Search functionality
  document.getElementById("searchInput").addEventListener("input", async function () {
    const query = this.value.trim();

    try {
      const url = query 
        ? `/admin/customers/search?q=${encodeURIComponent(query)}` 
        : `/admin/customers/search`;

      const res = await fetch(url);
      const data = await res.json();

      if (data.success) {
        const tbody = document.getElementById("customerTable");
        tbody.innerHTML = "";

        data.users.forEach((user, index) => {
          const tr = document.createElement("tr");
          tr.className = `border-b hover:bg-gray-50`;

          tr.innerHTML = `
            <td class="px-6 py-4">${index + 1}</td>
            <td class="px-6 py-4 font-medium">${user.name}</td>
            <td class="px-6 py-4">${user.email}</td>
            <td class="px-6 py-4">${user.mobile || '-'}</td>
            <td class="px-6 py-4">
              ${user.is_active
                ? '<span class="px-2 py-1 text-sm rounded-full bg-green-100 text-green-700">Active</span>'
                : '<span class="px-2 py-1 text-sm rounded-full bg-red-100 text-red-700">Blocked</span>'
              }
            </td>
            <td class="px-6 py-4">${new Date(user.createdAt).toDateString()}</td>
            <td class="px-6 py-4 text-center">
              <button 
                class="toggleBtn ${user.is_active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white px-4 py-2 rounded-md text-sm"
                data-id="${user._id}"
                data-active="${user.is_active}">
                ${user.is_active ? 'Block' : 'Unblock'}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Re-bind toggle buttons after search
        bindToggleButtons();
      }
    } catch (err) {
      console.error("Search failed", err);
    }
  });
</script>



<body class="flex flex-col min-h-screen">
  <!-- Page Title and Breadcrumb -->
  <div class="bg-gray-100 py-7 px-4">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-xl font-bold mb-2">Log In</h1>
      <nav class="text-sm text-gray-600">
        <a href="/" class="hover:underline font-medium">Nutrixo</a> / <span>Log In</span>
      </nav>
    </div>
  </div>

  <!-- Main Login Form -->
  <main class="flex-grow flex justify-center items-start py-12 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-md bg-white p-6 sm:p-8 rounded-md shadow-sm border">

      <!-- Google Login Button (optional) -->
      <a href="/auth/google" type="button" class="w-full flex items-center justify-center border border-gray-300 rounded-md py-4 text-sm mb-4 hover:bg-gray-50">
        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5 mr-2" />
        Continue with Google
      </a>

      <div class="text-center text-gray-500 mb-4">OR</div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-4 mt-3">
        <div>
          <label for="email" class="block text-sm font-medium">Email</label>
          <input type="email" name="email" id="email" required placeholder="Enter email"
                 class="w-full border rounded-md px-3 py-2 mt-1 text-sm focus:outline-none focus:ring-2" />
          <div id="errorEmail" class="error-class"></div>
        </div>

        <div>
          <label for="password" class="block text-sm font-medium">Password</label>
          <input type="password" name="password" id="password" required placeholder="Enter password"
                 class="w-full border rounded-md px-3 py-2 mt-1 text-sm focus:outline-none focus:ring-2" />
          <div id="errorPassword" class="error-class"></div>
          <div class="text-right mt-1">
            <a href="/auth/forgot-password" class="text-xs text-blue-600 hover:underline">Forgot password?</a>
          </div>
        </div>

        <button type="submit"
                class="w-full bg-gray-900 text-white py-2 rounded-md hover:bg-gray-800 transition">
          Log In
        </button>
      </form>

      <!-- Sign up prompt -->
      <p class="mt-6 text-center text-sm text-gray-600">
        Donâ€™t have an account?
        <a href="/auth/signup" class="text-blue-600 hover:underline">Sign Up</a>
      </p>
    </div>
  </main>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .error-class {
      display: block;
      min-height: 16px; 
      color: red;
      font-size: 0.75rem;
      margin-top: 2px;
    }
    .input-error {
      border-color: red !important;
    }
    .input-success {
      border-color: green !important;
    }
  </style>


  <script>
    
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorEmail = document.getElementById('errorEmail');
    const errorPassword = document.getElementById('errorPassword');
    const loginForm = document.getElementById('loginForm');
    
    function validateEmail() {
      const emailVal = emailInput.value.trim();
      const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailVal) {
        errorEmail.textContent = 'Please enter your email';
        emailInput.classList.add('input-error');
        emailInput.classList.remove('input-success');
      } else if (!emailPattern.test(emailVal)) {
        errorEmail.textContent = 'Invalid email format';
        emailInput.classList.add('input-error');
        emailInput.classList.remove('input-success');
      } else {
        errorEmail.textContent = '';
        emailInput.classList.remove('input-error');
        emailInput.classList.add('input-success');
      }
    }

    function validatePassword() {
      const passVal = passwordInput.value;
      if (!passVal) {
        errorPassword.textContent = 'Please enter your password';
        passwordInput.classList.add('input-error');
        passwordInput.classList.remove('input-success');
      } else if (passVal.length < 6) {
        errorPassword.textContent = 'Password must be at least 6 characters';
        passwordInput.classList.add('input-error');
        passwordInput.classList.remove('input-success');
      } else {
        errorPassword.textContent = '';
        passwordInput.classList.remove('input-error');
        passwordInput.classList.add('input-success');
      }
    }

    
    emailInput.addEventListener('input', validateEmail);
    passwordInput.addEventListener('input', validatePassword);

    
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      validateEmail();
      validatePassword();

      if (errorEmail.textContent || errorPassword.textContent) {
        
        return; 
      }

      const email = emailInput.value;
      const password = passwordInput.value;
      console.log("Sending fetch with:", { email, password });
      try{
      const res = await fetch('/auth/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({email, password})
      });

      const data = await res.json();

      console.log("Status:", res.status, "Data:", data);
      
      if (res.ok && data.success) {
        Swal.fire({
          icon:'success',
          title:data.message,
          timer:1500,
          showConfirmButton:false
        }).then(() => {
          window.location.href = data.redirect;
        });
      } else {
        Swal.fire({
          icon:'error',
          title:'Login failed',
          text:data.message || 'User is blocked by admin'
        });
      }
    } catch(err) {
      Swal.fire({
        icon:'error',
        title:'Error',
        text:'Could not connect to server'
      })
    }
    });

    const urlParams = new URLSearchParams(window.location.search)
    if(urlParams.get('blocked') === 'true') {
      Swal.fire({
        icon:'error',
        title:'Login failed',
        text:'Your account has been blocked by the admin'
      })
    }

  </script>
  
</body>

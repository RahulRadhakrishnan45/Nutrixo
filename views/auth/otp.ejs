<!-- Page Title and Breadcrumb -->
<div class="bg-gray-100 py-7 px-4">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-xl font-bold mb-2">Verify OTP</h1>
    <nav class="text-sm text-gray-600">
      <a href="/" class="hover:underline font-medium">Nutrixo</a>
      <span>/ Verify OTP</span>
    </nav>
  </div>
</div>

<!-- OTP Verification Form -->
<main class="flex-grow flex items-center justify-center px-4 py-10 min-h-[calc(100vh-12rem)] mt-[-110px]">
  <div class="max-w-md w-full">
    <p class="text-gray-600 mb-6">
      We’ve sent a 6-digit verification code to your email address.<br>
      Please enter the code below to continue.
    </p>

    <p id="timer" class="text-gray-600 font-medium mb-4 text-center text-lg"></p>

    <form onsubmit="return validateOtpForm()" class="space-y-6" action="/auth/verify-otp">
      <div>
        <label for="otp" class="block text-sm font-medium text-gray-700">Enter OTP</label>
        <input
          type="text"
          id="otp"
          name="otp"
          maxlength="6"
          required
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-black focus:border-black"
        />
      </div>

      <div>
        <button
          type="submit" 
          class="w-full bg-black text-white font-medium py-2 rounded-md hover:bg-gray-800 transition duration-200"
        >
          VERIFY
        </button>
      </div>

      <div class="text-sm text-center text-gray-600">
        Didn’t receive the code?
        <a href="#" id="resend-btn" onclick="resendOTP(); return false;" 
           class="text-blue-600 hover:underline font-medium">Resend OTP</a>
      </div>
    </form>
  </div>
</main>

<script>
  
  let expiryTime = <%= expiry %>; 

  function validateOtpForm() {
    const otpInput = document.getElementById('otp').value;

    fetch('/auth/verify-otp', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ otp: otpInput })
    })
    .then(res => res.json())
    .then(response => {
      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: 'OTP Verified!',
          text: response.message || 'Redirecting...',
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          window.location.href = response.redirect || '/auth/login';
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Invalid OTP',
          text: response.message || 'Please try again.'
        });
      }
    })
    .catch(() => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Something went wrong. Please try again.'
      });
    });

    return false; 
  }

  let countDown = null;
  const timerDisplay = document.getElementById('timer');
  const resendBtn = document.getElementById('resend-btn');

  function startTimer(expiry) {
    clearInterval(countDown);

    function updateTimer() {
      const now = Date.now();
      const remaining = Math.floor((expiry - now) / 1000);

      if (remaining > 0) {
        let minutes = Math.floor(remaining / 60);
        let seconds = remaining % 60;
        timerDisplay.textContent = `OTP expires in ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        
        // disable resend while OTP valid
        resendBtn.classList.add("pointer-events-none", "text-gray-400");
        resendBtn.classList.remove("text-blue-600");
      } else {
        clearInterval(countDown);
        timerDisplay.textContent = 'OTP Expired';

        // enable resend
        resendBtn.classList.remove("pointer-events-none", "text-gray-400");
        resendBtn.classList.add("text-blue-600");

        Swal.fire({
          icon: 'error',
          title: 'Time expired',
          text: 'Your OTP has expired. Please click "Resend OTP" to get a new code.',
        })
      }
    }

    updateTimer();
    countDown = setInterval(updateTimer, 1000);
  }

  // Start with backend expiry
  startTimer(expiryTime);

  function resendOTP() {
    fetch('/auth/resend-otp', {
      method: 'POST',
      headers: { 'content-type': 'application/json' }
    })
    .then(res => res.json())
    .then(response => {
      if (response.success) {
        expiryTime = response.expiry; // update expiry from backend
        startTimer(expiryTime);

        Swal.fire({
          icon: 'success',
          title: 'OTP Resent successfully',
          showConfirmButton: false,
          timer: 1500
        })
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An error occurred while resending OTP. Please try again'
        })
      }
    })
    .catch(() => {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Something went wrong. Please try again'
      })
    })
    return false;
  }
</script>

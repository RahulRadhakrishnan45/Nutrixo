<body class="bg-gray-100">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- ðŸ§­ Breadcrumb -->
    <nav class="text-sm mb-6 text-gray-500">
      <ol class="flex items-center space-x-2">
        <li><a href="/" class="hover:underline text-gray-600">Home</a></li>
        <li>/</li>
        <li class="text-gray-800 font-medium">Products</li>
      </ol>
    </nav>

    <!-- ðŸ§© Layout: Sidebar + Products -->
    <div class="flex gap-12">
      
      <!-- ðŸ§± Filters Sidebar -->
      <aside class="w-64 bg-white rounded-xl shadow p-6 hidden md:block">
        <h2 class="text-lg font-semibold mb-4">Categories</h2>
        <ul class="space-y-2">
          <li>
            <input type="radio" name="category" value="All"
              <%= !selectedFilters.category ? 'checked' : '' %> class="mr-2"> All
          </li>
          <% categories.forEach(c => { %>
            <li>
              <input type="radio" name="category" value="<%= c %>"
                <%= selectedFilters.category === c ? 'checked' : '' %> class="mr-2"> <%= c %>
            </li>
          <% }) %>
        </ul>

        <!-- ðŸ·ï¸ Brand -->
        <div class="mt-6">
          <label class="block font-medium mb-2">Select Brand</label>
          <select class="w-full border rounded p-2" name="brand">
            <option value="All" <%= !selectedFilters.brand ? 'selected' : '' %>>All</option>
            <% brands.forEach(b => { %>
              <option value="<%= b %>" <%= selectedFilters.brand === b ? 'selected' : '' %>><%= b %></option>
            <% }) %>
          </select>
        </div>

        <!-- ðŸ“ Flavour -->
        <div class="mt-6">
          <label class="block font-medium mb-2">Select Flavour</label>
          <select class="w-full border rounded p-2" name="flavour">
            <option value="All" <%= !selectedFilters.flavour ? 'selected' : '' %>>All</option>
            <% flavours.forEach(f => { %>
              <option value="<%= f %>" <%= selectedFilters.flavour === f ? 'selected' : '' %>><%= f %></option>
            <% }) %>
          </select>
        </div>

        <!-- âš–ï¸ Weight -->
        <div class="mt-6">
          <label class="block font-medium mb-2">Select Weight</label>
          <select class="w-full border rounded p-2" name="size">
            <option value="All" <%= !selectedFilters.size ? 'selected' : '' %>>All</option>
            <% sizes.forEach(s => { %>
              <option value="<%= s %>" <%= selectedFilters.size === s ? 'selected' : '' %>><%= s %></option>
            <% }) %>
          </select>
        </div>

        <!-- ðŸ’° Price Range -->
        <div class="mt-6">
          <label class="block font-medium mb-2">Price Range</label>
          <div class="flex gap-2 items-center">
            <input type="number" id="minPrice" min="100" step="100"
              class="w-1/2 border rounded p-2" placeholder="Min"
              value="<%= selectedFilters.minPrice || '' %>">

            <input type="number" id="maxPrice" min="100" step="100"
              class="w-1/2 border rounded p-2" placeholder="Max"
              value="<%= selectedFilters.maxPrice || '' %>">
          </div>
          <button onclick="applyFilters()" 
            class="mt-3 w-full bg-blue-600 text-white py-2 rounded">Apply</button>
        </div>

        <!-- ðŸ§¹ Clear Filters -->
        <% if (selectedFilters.brand || selectedFilters.flavour || selectedFilters.size || selectedFilters.minPrice || selectedFilters.maxPrice || selectedFilters.category) { %>
          <div class="mt-6">
            <button onclick="clearFilters()" 
              class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 rounded">
              Clear Filters
            </button>
          </div>
        <% } %>
      </aside>

      <!-- ðŸ›ï¸ Products Section -->
      <main class="flex-1">
        <div class="flex justify-between items-center mb-6">
          <p class="text-gray-600">Showing <%= products.length %> Results</p>
          <select class="border rounded p-2" name="sort" onchange="applyFilters()">
            <option value="">Sort by</option>
            <option value="priceLowHigh" <%= selectedFilters.sort === 'priceLowHigh' ? 'selected' : '' %>>Price: Low to High</option>
            <option value="priceHighLow" <%= selectedFilters.sort === 'priceHighLow' ? 'selected' : '' %>>Price: High to Low</option>
            <option value="nameAZ" <%= selectedFilters.sort === 'nameAZ' ? 'selected' : '' %>>Name: aA-zZ</option>
            <option value="nameZA" <%= selectedFilters.sort === 'nameZA' ? 'selected' : '' %>>Name: zZ-aA</option>
          </select>
        </div>

        <!-- ðŸ§± Product Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
          <% products.forEach(variant => { 
              const inWishlist = userWishlist?.includes(variant._id.toString());
          %>
            <a href="/products/<%= variant.productId %>?variant=<%= variant._id %>"
              class="relative bg-white rounded-xl shadow hover:shadow-lg transition p-4 block group">

              <!-- â¤ï¸ Wishlist Heart -->
              <button 
                onclick="toggleWishlist(event, '<%= variant._id %>')" 
                class="absolute top-3 right-3 text-gray-400 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" 
                     viewBox="0 0 24 24" fill="<%= inWishlist ? 'red' : 'none' %>" 
                     stroke="currentColor" stroke-width="1.5"
                     class="w-6 h-6 group-hover:scale-110 transition-transform"
                     id="heart-<%= variant._id %>">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.767 0-3.307 1.008-4.062 2.49-.755-1.482-2.295-2.49-4.062-2.49C5.099 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                </svg>
              </button>

              <!-- ðŸ–¼ï¸ Product Image -->
              <img src="<%= variant.image %>" alt="<%= variant.name %>" 
                   class="h-48 w-full object-contain mb-4">

              <!-- ðŸ“ Product Details -->
              <h3 class="font-semibold text-lg"><%= variant.name %></h3>
              <p class="text-gray-500 text-sm">â˜…â˜…â˜…â˜…â˜…</p>

              <% if (variant.stock > 0) { %>
                <p class="text-green-600 font-semibold">IN STOCK (<%= variant.stock %>)</p>
              <% } else { %>
                <p class="text-red-600 font-semibold">OUT OF STOCK</p>
              <% } %>

              <div class="mt-2">
                <span class="line-through text-gray-400">â‚¹ <%= variant.original_price %></span>
                <span class="ml-2 text-xl font-bold text-gray-900">â‚¹ <%= variant.discounted_price %></span>
              </div>
            </a>
          <% }) %>
        </div>
      </main>
    </div>
  </div>

  <!-- ðŸ“„ Pagination -->
  <%- include('../partials/pagination.ejs', { currentPage, totalPages }) %>

  <!-- âš™ï¸ Scripts -->
  <script>
  // âœ… Apply Filters
  function applyFilters() {
    const params = new URLSearchParams();
    const brand = document.querySelector("select[name='brand']").value;
    const flavour = document.querySelector("select[name='flavour']").value;
    const size = document.querySelector("select[name='size']").value;
    const minPrice = document.getElementById("minPrice").value;
    const maxPrice = document.getElementById("maxPrice").value;
    const category = document.querySelector("input[name='category']:checked")?.value;
    const sort = document.querySelector("select[name='sort']").value;

    if (brand && brand !== "All") params.append("brand", brand);
    if (flavour && flavour !== "All") params.append("flavour", flavour);
    if (size && size !== "All") params.append("size", size);
    if (minPrice) params.append("minPrice", minPrice);
    if (maxPrice) params.append("maxPrice", maxPrice);
    if (category && category !== "All") params.append("category", category);
    if (sort) params.append("sort", sort);

    window.location.href = "/products?" + params.toString();
  }

  // âœ… Clear Filters
  function clearFilters() {
    document.querySelector("select[name='brand']").value = "All";
    document.querySelector("select[name='flavour']").value = "All";
    document.querySelector("select[name='size']").value = "All";
    document.getElementById("minPrice").value = "";
    document.getElementById("maxPrice").value = "";
    document.querySelector("input[name='category'][value='All']").checked = true;
    window.location.href = "/products";
  }

  // âœ… Wishlist Toggle (no duplicates + dynamic badge)
  async function toggleWishlist(event, variantId) {
    event.preventDefault();
    event.stopPropagation();

    const heart = document.getElementById(`heart-${variantId}`);
    const isFilled = heart.getAttribute("fill") === "red";

    if (isFilled) {
      await removeFromWishlist(variantId);
      heart.setAttribute("fill", "none");
    } else {
      await addToWishlist(variantId);
      heart.setAttribute("fill", "red");
    }

    await updateWishlistBadgeFromServer(); // âœ… live header sync
  }

  // âœ… Add to Wishlist
  async function addToWishlist(variantId) {
    try {
      const res = await fetch(`/wishlist/${variantId}`, { method: "POST" });
      const data = await res.json();
      if (!data.success && data.message?.includes("Duplicate")) {
        console.warn("Already in wishlist");
      }
    } catch (err) {
      console.error("Error adding to wishlist:", err);
    }
  }

  // âœ… Remove from Wishlist
  async function removeFromWishlist(variantId) {
    try {
      const res = await fetch(`/wishlist/${variantId}`, { method: "DELETE" });
      const data = await res.json();
      if (!data.success) console.warn(data.message);
    } catch (err) {
      console.error("Error removing from wishlist:", err);
    }
  }

  // âœ… Dynamic Badge Refresh (header)
  async function updateWishlistBadgeFromServer() {
    try {
      const res = await fetch("/wishlist/count");
      const data = await res.json();
      const badge = document.getElementById("wishlistText");
      if (!badge) return;

      if (data.count > 0) {
        badge.textContent = data.count;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    } catch (err) {
      console.error("Error updating wishlist badge:", err);
    }
  }

  // âœ… Auto sync on page load
  document.addEventListener("DOMContentLoaded", updateWishlistBadgeFromServer);
  </script>
</body>

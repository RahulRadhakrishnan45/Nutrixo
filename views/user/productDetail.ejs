<div class="container mx-auto py-8">
  <!-- Product Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
    
    <!-- Product Images -->
    <div>
      <div class="swiper mySwiper w-full max-w-md">
        <div class="swiper-wrapper" id="productImages">
          <% if (selectedVariant && selectedVariant.images.length > 0) { %>
            <% selectedVariant.images.forEach(image => { %>
              <div class="swiper-slide">
                <div class="zoom-container w-full h-96 rounded-lg overflow-hidden cursor-zoom-in">
                  <img src="<%= image %>" alt="<%= product.title %>" class="zoom-image w-full h-full object-contain rounded-lg" />
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="swiper-slide">
              <div class="zoom-container w-full h-96 rounded-lg overflow-hidden cursor-zoom-in">
                <img src="/images/no-image.png" alt="No Image" class="zoom-image w-full h-full object-contain rounded-lg" />
              </div>
            </div>
          <% } %>
        </div>
        <!-- Swiper navigation -->
        <div class="swiper-button-next !text-gray-500"></div>
        <div class="swiper-button-prev !text-gray-500"></div>
        <div class="swiper-pagination !text-gray-500"></div>
      </div>
    </div>

    <!-- Product Info -->
    <div>
      <h1 class="text-3xl font-bold mb-4"><%= product.title %></h1>
      
      <!-- Price -->
      <p class="text-2xl font-bold text-gray-800 mb-2">
        ‚Çπ <span id="productPrice"><%= selectedVariant.discounted_price || selectedVariant.price %></span>
      </p>
      
      <!-- Stock -->
      <p class="mb-4 text-sm text-gray-600" id="productStock">
        <%= selectedVariant.stock > 0 ? `IN STOCK (${selectedVariant.stock})`: 'OUT OF STOCK' %>
      </p>

      <!-- Variant Dropdowns -->
      <div class="flex gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">Flavour</label>
          <select id="flavourSelect" class="border px-3 py-2 rounded w-40">
            <% let flavours = [...new Set(product.variants.map(v => v.flavour))]; %>
            <% flavours.forEach(f => { %>
              <option value="<%= f %>" <%= f === selectedVariant.flavour ? "selected" : "" %>>
                <%= f %>
              </option>
            <% }) %>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Size</label>
          <select id="sizeSelect" class="border px-3 py-2 rounded w-32">
            <% let sizes = [...new Set(product.variants.map(v => v.size))]; %>
            <% sizes.forEach(s => { %>
              <option value="<%= s %>" <%= s === selectedVariant.size ? "selected" : "" %>>
                <%= s %>
              </option>
            <% }) %>
          </select>
        </div>
      </div>

      <!-- Quantity Selector -->
      <div class="flex items-center mb-4">
        <button type="button" id="decreaseQty" class="px-3 py-1 border">-</button>
        <input type="number" id="quantityInput" value="1" class="w-16 text-center border" />
        <button type="button" id="increaseQty" class="px-3 py-1 border">+</button>
      </div>

      <!-- Add to Cart + Wishlist -->
      <div class="flex items-center gap-3 mt-12"> 
        <button id="addToCartBtn" type="button" onclick="return false;" class="bg-black text-white px-8 py-3 rounded text-base font-semibold w-auto min-w-[350px]">
          Add to cart
        </button>
        <!-- Wishlist Heart -->
        <button id="wishlistBtn"
          class="border border-gray-300 rounded p-2 hover:bg-gray-100 transition"
          onclick="toggleWishlistDetail()">
            <i id="wishlistIcon"
              class="fa fa-heart text-[1.2rem] <%= userWishlist?.includes(selectedVariant._id.toString()) ? 'text-red-500' : 'text-gray-400' %>">
            </i>
        </button>

      </div>
    </div>
  </div>
</div> <!-- ‚úÖ close product section container -->

<!-- Details & Reviews (full width) -->
<div class="container mx-auto py-8">
  <div class="mt-10">
    <ul class="flex border-b">
      <li class="mr-6"><a href="#" class="tab-link font-bold">Details</a></li>
      <li><a href="#" class="tab-link">Reviews</a></li>
    </ul>
    <div class="tab-content mt-4">
      <p><%= product.description %></p>
    </div>
  </div>
</div>

<!-- Related Products (full width below) -->
<div class="container mx-auto py-8">
  <h2 class="text-xl font-bold mb-4">You might also like</h2>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
    <% relatedProducts.forEach(rp => { %>
      <div class="border p-4 rounded-lg text-center">
        <img src="<%= rp.variants[0]?.images?.[0] || '/images/no-image.png' %>" 
             alt="<%= rp.title %>" 
             class="mb-2 w-full h-40 object-contain" />
        <h3 class="text-sm font-bold"><%= rp.title %></h3>
        <p class="text-gray-600">‚Çπ <%= rp.variants[0]?.discounted_price || rp.variants[0]?.price %></p>
        <a href="/products/<%= rp._id %>?variant=<%= rp.variants[0]?._id %>" 
           class="text-blue-500 mt-2 inline-block">View</a>
      </div>
    <% }) %>
  </div>
</div>

<style>
  .zoom-container {
    position: relative;
    overflow: hidden;
  }

  .zoom-image {
    transition: transform 0.2s ease;
    transform-origin: center center;
    will-change: transform;
  }
</style>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<style>
  
  #toast-container > .toast-warning {
    background-color: #000000 !important; 
    color: #ffffff !important;            
    font-weight: 600;                     
    border: 1px solid #333333;            
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  #toast-container > .toast-warning .toast-close-button {
    color: #ffffff !important;
    font-weight: 700;
    opacity: 1 !important;
  }
</style>





<script>
  
  const swiper = new Swiper(".mySwiper", {
    loop: true,
    spaceBetween: 10,
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev"
    },
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },
  });

  const variants = <%- JSON.stringify(product.variants) %>;
  const selectedVariantId = "<%= selectedVariant._id %>";

  const flavourSelect = document.getElementById("flavourSelect");
  const sizeSelect = document.getElementById("sizeSelect");
  const productPrice = document.getElementById("productPrice");
  const productStock = document.getElementById("productStock");
  const productImages = document.getElementById("productImages");

  function updateProductDetails() {
    const selectedFlavour = flavourSelect.value;
    const selectedSize = sizeSelect.value;

    const variant = variants.find(v => v.flavour === selectedFlavour && v.size === selectedSize);

    if (variant) {
      productPrice.innerText = variant.discounted_price || variant.price;
      productStock.innerText = variant.stock > 0 ? `IN STOCK (${variant.stock})` : "OUT OF STOCK";

      // Update images in swiper
      productImages.innerHTML = "";
      variant.images.forEach(img => {
        const slide = document.createElement("div");
        slide.className = "swiper-slide";
        slide.innerHTML = `
          <div class="zoom-container w-full h-96 rounded-lg overflow-hidden cursor-zoom-in">
            <img src="${img}" alt="${variant.flavour}" class="zoom-image w-full h-full object-contain rounded-lg" />
          </div>
        `;
        productImages.appendChild(slide);
      });

      
      swiper.update();
      swiper.slideTo(0);
      applyZoomAgain();

      const newUrl = `${window.location.pathname}?variant=${variant._id}`;
      window.history.replaceState({}, "", newUrl);
    }
  }

  if (!window.location.search.includes("variant=") && selectedVariantId) {
    const newUrl = `${window.location.pathname}?variant=${selectedVariantId}`;
    window.location.replace(newUrl);
  }  

  flavourSelect.addEventListener("change", updateProductDetails);
  sizeSelect.addEventListener("change", updateProductDetails);

  // ‚úÖ Quantity + Toastr
  toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-bottom-right",
    timeOut: "2000"
  };

  const qtyInput = document.getElementById("quantityInput");
  const decBtn = document.getElementById("decreaseQty");
  const incBtn = document.getElementById("increaseQty");

  decBtn.addEventListener("click", () => {
    if (parseInt(qtyInput.value) > 1) {
      qtyInput.value = parseInt(qtyInput.value) - 1;
    }
  });

  incBtn.addEventListener("click", () => {
    let newVal = parseInt(qtyInput.value) + 1;
    if (newVal > 5) {
      toastr.warning("Only 5 units can be purchased");
      qtyInput.value = 5;
      return;
    }
    qtyInput.value = newVal;
  });

  qtyInput.addEventListener("input", (e) => {
    let val = parseInt(e.target.value);
    if (isNaN(val) || val < 1) {
      e.target.value = 1;
    } else if (val > 5) {
      toastr.warning("Only 5 units can be purchased");
      e.target.value = 5;
    }
  });

  // Function to enable magnifier effect
  function enableZoom(container) {
    const img = container.querySelector(".zoom-image");

    container.addEventListener("mousemove", (e) => {
      const rect = container.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;

      img.style.transformOrigin = `${x}% ${y}%`;
      img.style.transform = "scale(2)"; // zoom level
    });

    container.addEventListener("mouseleave", () => {
      img.style.transformOrigin = "center center";
      img.style.transform = "scale(1)";
    });
  }

  // Run zoom effect for all visible slides
  document.querySelectorAll(".zoom-container").forEach(enableZoom);

  // Also re-run when variants update (after swiper.update())
  function applyZoomAgain() {
    document.querySelectorAll(".zoom-container").forEach(enableZoom);
  }

  const addToCartBtn = document.getElementById('addToCartBtn')

  addToCartBtn.addEventListener('click', async (e) => {
    e.preventDefault()
    e.stopPropagation()
    if(addToCartBtn.textContent.trim() === 'Add to cart') {
      const selectedFlavour = flavourSelect.value
      const selectedSize = sizeSelect.value
      const quantity = parseInt(document.getElementById('quantityInput').value)

      const variant = variants.find(v => v.flavour === selectedFlavour && v.size === selectedSize)

      if(!variant) {
        toastr.error('Please select a valid variant')
        return
      }

      try{
        const res = await fetch('/cart', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            productId:'<%= product._id %>',
            variantId:variant._id,
            quantity:quantity
          })
        })

        if(res.status === 401) {
          toastr.error('please login to add items to cart')
          setTimeout(() => window.location.href = '/auth/login',1500)
          return 
        }

        const data = await res.json()

        if(res.ok) {
          toastr.success('Added to cart')
          addToCartBtn.textContent = 'Go to cart'

          if(data.cartLength !== undefined) {
            updateCartBadge(data.cartLength)
          }
        }else{
          toastr.error(data.message || 'Failed to add to cart')
        }
      }catch(err) {
        toastr.error('something went wrong')
      }
    }else{
      window.location.href = '/cart'
    }
  })
  
    async function toggleWishlistDetail() {
    const heartIcon = document.getElementById("wishlistIcon");
    const selectedFlavour = flavourSelect.value;
    const selectedSize = sizeSelect.value;
    const variant = variants.find(v => v.flavour === selectedFlavour && v.size === selectedSize);

    if (!variant) {
      toastr.error("Please select a valid variant");
      return;
    }

    const isWishlisted = heartIcon.classList.contains("text-red-500");

    try {
      if (isWishlisted) {
        // üóë Remove from wishlist
        const res = await fetch(`/wishlist/${variant._id}`, { method: "DELETE" });
        const data = await res.json();
        if (data.success) {
          heartIcon.classList.remove("text-red-500");
          heartIcon.classList.add("text-gray-400");
          toastr.warning("Removed from wishlist");
          await updateBadgesFromServer(); // ‚úÖ instantly refresh header badge
        } else {
          toastr.error(data.message || "Failed to remove from wishlist");
        }
      } else {
        // ‚ù§Ô∏è Add to wishlist
        const res = await fetch(`/wishlist/${variant._id}`, { method: "POST" });
        const data = await res.json();
        if (data.success) {
          heartIcon.classList.add("text-red-500");
          heartIcon.classList.remove("text-gray-400");
          toastr.success("Added to wishlist");
          await updateBadgesFromServer();
        } else if (data.message?.includes("Duplicate")) {
          toastr.info("Already in wishlist");
        } else {
          toastr.error(data.message || "Failed to add to wishlist");
        }
      }
    } catch (err) {
      console.error("Wishlist toggle error:", err);
      toastr.error("Something went wrong");
    }
  }

  // üß† Update heart color automatically when variant changes
  const userWishlist = <%- JSON.stringify(userWishlist || []) %>;

  function updateWishlistHeart(variantId) {
    const heartIcon = document.getElementById("wishlistIcon");
    if (userWishlist.includes(variantId)) {
      heartIcon.classList.add("text-red-500");
      heartIcon.classList.remove("text-gray-400");
    } else {
      heartIcon.classList.add("text-gray-400");
      heartIcon.classList.remove("text-red-500");
    }
  }

  // Update wishlist heart when variant changes
  function updateProductDetails() {
    const selectedFlavour = flavourSelect.value;
    const selectedSize = sizeSelect.value;
    const variant = variants.find(v => v.flavour === selectedFlavour && v.size === selectedSize);

    if (variant) {
      productPrice.innerText = variant.discounted_price || variant.price;
      productStock.innerText = variant.stock > 0 ? `IN STOCK (${variant.stock})` : "OUT OF STOCK";

      productImages.innerHTML = "";
      variant.images.forEach(img => {
        const slide = document.createElement("div");
        slide.className = "swiper-slide";
        slide.innerHTML = `
          <div class="zoom-container w-full h-96 rounded-lg overflow-hidden cursor-zoom-in">
            <img src="${img}" alt="${variant.flavour}" class="zoom-image w-full h-full object-contain rounded-lg" />
          </div>`;
        productImages.appendChild(slide);
      });

      swiper.update();
      swiper.slideTo(0);
      applyZoomAgain();

      const newUrl = `${window.location.pathname}?variant=${variant._id}`;
      window.history.replaceState({}, "", newUrl);

      // ‚úÖ Automatically update wishlist heart color when user switches variants
      updateWishlistHeart(variant._id.toString());
    }
  }

</script>

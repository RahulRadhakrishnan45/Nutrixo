<!-- Outer wrapper ensures centering inside the layout's <main> -->
<div class="w-full flex justify-center py-10">
  <!-- Card: centered, limited width, responsive padding -->
  <div class="max-w-7xl w-full bg-white shadow-md rounded-lg p-6 mx-4">
    <!-- Heading -->
    <h1 class="text-2xl font-bold text-center mb-6">Order Tracking</h1>
    <p class="text-center text-gray-600 mb-8">
      Track your order status and delivery information
    </p>

    <% if (!order) { %>
    <p class="text-center text-red-500">Order not found.</p>
    <% } else { %>

    <!-- Product Details -->
    <% if (primaryItem) { %>
    <div class="flex items-center gap-4 border-b pb-4 mb-6">
      <img
        src="<%= primaryItem.image %>"
        alt="product"
        class="w-20 h-20 object-cover rounded"
      />
      <div>
        <h2 class="font-bold text-lg"><%= primaryItem.title %></h2>
        <p class="text-sm text-gray-600">
          Size: <%= primaryItem.size || '-' %> | Qty: <%= primaryItem.quantity
          %>
        </p>
        <p class="text-black font-semibold">₹<%= primaryItem.price %></p>
        <p class="mt-1">
          Payment Status:
          <span
            class="px-2 py-1 rounded text-white text-sm <%= order.paymentStatus === 'PENDING' ? 'bg-yellow-500' : order.paymentStatus === 'COMPLETED' ? 'bg-green-500' : 'bg-red-500' %>"
          >
            <%= order.paymentStatus %>
          </span>
        </p>
      </div>
    </div>
    <% } else { %>
    <p class="text-gray-500 mb-6">No items found in this order.</p>
    <% } %>

    <!-- Timeline -->
    <div class="flex justify-between items-center mb-6 relative w-full px-2">
      <% const statuses = [ { key: 'PROCESSING', label: 'Processing', icon:
      'clock' }, { key: 'PACKED', label: 'Packed', icon: 'box' }, { key:
      'SHIPPED', label: 'Shipped', icon: 'truck' }, { key: 'DELIVERED', label:
      'Delivered', icon: 'check-circle' }, { key: 'RETURNED', label: 'Returned',
      icon: 'rotate-ccw' }, { key: 'CANCELLATION REQUESTED', label:
      'Cancellation Requested', icon: 'x-circle' }, { key: 'CANCELLED', label:
      'Cancelled', icon: 'x-circle' } ]; const currentStatus = primaryItem ?
      primaryItem.status : 'PROCESSING'; const currentIndex =
      statuses.findIndex(s => s.key === currentStatus); %> <%
      statuses.forEach((status, index) => { %>
      <div class="flex flex-col items-center w-full relative">
        <!-- Circle -->
        <div
          class="mb-2 w-12 h-12 flex items-center justify-center rounded-full <%= status.key === 'CANCELLATION REQUESTED' ? 'bg-orange-400' : (primaryItem.status === 'CANCELLATION REQUESTED' && status.key === 'CANCELLED') ? 'bg-gray-200' : index <= currentIndex ? 'bg-black' : 'bg-gray-200' %>"
        >
          <% if (status.icon === 'clock') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <% } else if (status.icon === 'box') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 12V7a2 2 0 00-2-2h-4l-2-2-2 2H6a2 2 0 00-2 2v5h16zM4 12v5a2 2 0 002 2h12a2 2 0 002-2v-5"
            />
          </svg>
          <% } else if (status.icon === 'truck') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 17v-2a1 1 0 011-1h9.586a1 1 0 01.707.293l2.414 2.414A1 1 0 0123 17v2a2 2 0 01-2 2h-1a2 2 0 11-4 0H9a2 2 0 01-4 0H4a2 2 0 01-2-2v-2a1 1 0 011-1h6a1 1 0 011 1v2z"
            />
          </svg>
          <% } else if (status.icon === 'check-circle') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m7 2a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <% } else if (status.icon === 'rotate-ccw') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v6h6M20 20v-6h-6M20 4l-8 8-8-8"
            />
          </svg>
          <% } else if (status.icon === 'x-circle') { %>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 <%= index <= currentIndex ? 'text-white' : 'text-gray-500' %>"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
          <% } %>
        </div>

        <!-- Label -->
        <p
          class="text-sm <%= index <= currentIndex ? 'font-bold text-black' : 'text-gray-500' %>"
        >
          <%= status.label %>
        </p>

        <!-- Connector line -->
        <% if (index < statuses.length - 1) { %>
        <div
          class="absolute top-6 left-full h-1 w-full <%= (primaryItem.status === 'CANCELLATION REQUESTED' && status.key === 'CANCELLATION REQUESTED') ? 'bg-gray-300' : index < currentIndex ? 'bg-black' : 'bg-gray-300' %>"
        ></div>
        <% } %>
      </div>
      <% }); %>
    </div>

    <!-- Cancel Item Button (Modal Trigger) -->
    <div class="flex justify-end mb-4">
      <% if (primaryItem && (primaryItem.status === 'PROCESSING' ||
      primaryItem.status === 'PACKED')) { %>
      <button
        onclick="openCancelModal('<%= order._id %>', '<%= primaryItem._id %>')"
        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
      >
        Cancel Item
      </button>
      <% } %>
    </div>

    <!-- Delivery + Order Summary -->
    <div class="grid grid-cols-2 gap-8">
      <!-- Address -->
      <div>
        <h3 class="font-bold text-lg mb-3">Delivery Address</h3>
        <% if (order.orderAddress) { %>
        <p><strong><%= order.orderAddress.fullname || '-' %></strong></p>
        <p>
          <%= order.orderAddress.address || '-' %>, <%= order.orderAddress.state
          || '-' %>
        </p>
        <p><%= order.orderAddress.pincode || '-' %></p>
        <% } else { %>
        <p class="text-gray-500">No address found</p>
        <% } %>
      </div>

      <!-- Summary -->
      <div>
        <h3 class="font-bold text-lg mb-3">Order Summary</h3>

        <% if (primaryItem) { const TAX_RATE = 0.02; const qty =
        primaryItem.quantity || 1; const pricePerUnit = Number(primaryItem.price
        || 0); const subtotal = pricePerUnit * qty; const tax = subtotal *
        TAX_RATE; const discount = 0; const total = subtotal + tax - discount;
        %>

        <!-- Per-item breakdown -->
        <div class="flex justify-between text-gray-700 mb-2">
          <div>
            <p class="font-medium">
              <%= primaryItem.title %>
              <span class="text-xs text-gray-500">x<%= qty %></span>
            </p>
            <p class="text-xs text-gray-500">
              Price: ₹<%= pricePerUnit.toFixed(2) %> /unit
            </p>
          </div>
          <div class="text-right">
            <p class="font-medium">₹<%= subtotal.toFixed(2) %></p>
          </div>
        </div>

        <hr class="my-2" />

        <!-- Totals -->
        <div class="flex justify-between text-gray-700">
          <p>Subtotal</p>
          <p>₹<%= subtotal.toFixed(2) %></p>
        </div>
        <div class="flex justify-between text-green-600">
          <p>Discount</p>
          <p>- ₹<%= discount.toFixed(2) %></p>
        </div>
        <div class="flex justify-between text-gray-700">
          <p>Tax (2%)</p>
          <p>₹<%= tax.toFixed(2) %></p>
        </div>

        <hr class="my-2" />

        <div class="flex justify-between font-bold text-lg">
          <p>Total</p>
          <p>₹<%= total.toFixed(2) %></p>
        </div>

        <% } else { %>
        <p class="text-gray-500">No item selected for summary.</p>
        <% } %>
      </div>
    </div>

    <% } %>
  </div>
</div>

<!-- ❗ Cancel Item Modal -->
<div
  id="cancelModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50"
>
  <div class="bg-white rounded-lg p-6 w-96 shadow-lg">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Cancel Product</h2>
    <textarea
      id="cancelReason"
      rows="4"
      class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring focus:ring-red-200 outline-none"
      placeholder="Enter cancellation reason..."
    ></textarea>
    <div class="flex justify-end mt-4 space-x-3">
      <button
        onclick="closeCancelModal()"
        class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300"
      >
        Close
      </button>
      <button
        onclick="submitCancelOrder()"
        class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
      >
        Submit
      </button>
    </div>
  </div>
</div>

<!-- ✅ Toastr JS + CSS -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-bottom-right",
    timeOut: 3000,
  };

  let selectedOrderId = null;
  let selectedItemId = null;

  function openCancelModal(orderId, itemId) {
    selectedOrderId = orderId;
    selectedItemId = itemId;
    document.getElementById("cancelModal").classList.remove("hidden");
    document.getElementById("cancelModal").classList.add("flex");
  }

  function closeCancelModal() {
    selectedOrderId = null;
    selectedItemId = null;
    document.getElementById("cancelReason").value = "";
    document.getElementById("cancelModal").classList.remove("flex");
    document.getElementById("cancelModal").classList.add("hidden");
  }

  async function submitCancelOrder() {
    const reason = document.getElementById("cancelReason").value.trim();
    if (!reason) {
      toastr.warning("Please enter a reason for cancellation.");
      return;
    }

    try {
      const res = await fetch(
        `/orders/${selectedOrderId}/item/${selectedItemId}/cancel`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reason }),
        }
      );

      if (res.ok) {
        toastr.success("Product cancellation requested successfully.");

        // ✅ Disable the cancel button
        const cancelButton = document.querySelector(
          `button[onclick="openCancelModal('${selectedOrderId}', '${selectedItemId}')"]`
        );
        if (cancelButton) {
          cancelButton.disabled = true;
          cancelButton.textContent = "⏳ Cancellation Requested";
          cancelButton.className =
            "bg-gray-300 text-gray-600 px-4 py-2 rounded cursor-not-allowed transition";
        }

        // ✅ Update the timeline dynamically (like your image)
        const circles = document.querySelectorAll(
          ".flex.flex-col.items-center.w-full.relative > div:first-child"
        );
        const labels = document.querySelectorAll(
          ".flex.flex-col.items-center.w-full.relative > p"
        );
        const lines = document.querySelectorAll(
          ".absolute.top-6.left-full.h-1.w-full"
        );

        const cancellationIndex = Array.from(labels).findIndex(
          (l) => l.textContent.trim() === "Cancellation Requested"
        );
        const cancelledIndex = Array.from(labels).findIndex(
          (l) => l.textContent.trim() === "Cancelled"
        );

        circles.forEach((circle, index) => {
          const label = labels[index];
          // Reset styles
          circle.classList.remove("bg-black", "bg-orange-400", "bg-gray-200");
          label.classList.remove("text-gray-500", "font-bold", "text-black");

          // ✅ Before Cancellation Requested → Black
          if (index < cancellationIndex) {
            circle.classList.add("bg-black");
            label.classList.add("font-bold", "text-black");
          }

          // ✅ Cancellation Requested → Orange
          else if (index === cancellationIndex) {
            circle.classList.add("bg-orange-400");
            label.classList.add("font-bold", "text-black");
          }

          // ✅ After that → Gray
          else {
            circle.classList.add("bg-gray-200");
            label.classList.add("text-gray-500");
          }
        });

        // ✅ Update connecting lines
        lines.forEach((line, index) => {
          line.classList.remove("bg-black", "bg-gray-300");
          if (index < cancellationIndex) {
            line.classList.add("bg-black"); // till “Cancellation Requested”
          } else {
            line.classList.add("bg-gray-300"); // remaining gray
          }
        });
      } else {
        toastr.error("Failed to cancel product. Please try again.");
      }
    } catch (err) {
      console.error(err);
      toastr.error("Error cancelling product.");
    } finally {
      closeCancelModal();
    }
  }
</script>
<style>
  .transition { transition: all 0.4s ease-in-out; }
</style>


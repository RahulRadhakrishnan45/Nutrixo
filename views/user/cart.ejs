<div class="container mx-auto px-6 py-10">
  <!-- Breadcrumb -->
  <div class="py-3 px-6 mb-10">
    <nav class="text-sm text-gray-500">
      <ol class="flex items-center space-x-2">
        <li><a href="/" class="hover:underline text-gray-600">Nutrixo</a></li>
        <li>/</li>
        <li class="text-gray-800 font-medium">Cart</li>
      </ol>
    </nav>
  </div>

  <!-- Cart Grid -->
  <div class="grid <%= cartItems && cartItems.length > 0 ? 'grid-cols-1 lg:grid-cols-3' : 'grid-cols-1' %> gap-10">
    
    <!-- Cart Items -->
    <div class="<%= cartItems && cartItems.length > 0 ? 'lg:col-span-2 space-y-6' : 'col-span-1' %>" id="cart-items">
      <% if(cartItems && cartItems.length > 0) { %>
        <% cartItems.forEach(item => { 
          const offerPercent = item.variant.offerPercent || 0;
          const price = item.variant.price;
          const finalPrice = offerPercent > 0 ? (price - (price * offerPercent / 100)).toFixed(2) : price;
        %>
        <div id="item-<%= item._id %>" class="flex items-center border-b pb-4">
          <!-- Product Image -->
          <img
            src="<%= item.variant.images[0] || '/images/no-image.png' %>"
            alt="<%= item.product.title %>"
            class="w-20 h-20 object-contain rounded border mr-4"
          />

          <!-- Product Details -->
          <div class="flex-1">
            <h2 class="text-lg font-semibold"><%= item.product.title %></h2>
            <p class="text-sm text-gray-600">
              <%= item.variant.flavour %> Flavour â€” Quantity: <%= item.variant.size %>
            </p>
            
            <!-- Dynamic offer display -->
            <div class="flex items-baseline gap-2 mt-1">
              <p class="text-gray-800 font-bold">
                â‚¹ <%= finalPrice %>
              </p>
              <% if (offerPercent > 0) { %>
                <span class="line-through text-gray-400 text-sm">â‚¹ <%= price %></span>
                <span class="bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded">
                  <%= offerPercent %>% OFF
                </span>
              <% } %>
            </div>
          </div>

          <!-- Quantity Controls -->
          <div class="flex items-center space-x-2">
            <button class="decreaseBtn px-2 py-1 border rounded" data-id="<%= item._id %>">âˆ’</button>
            <span id="qty-<%= item._id %>"><%= item.quantity %></span>
            <button class="increaseBtn px-2 py-1 border rounded" data-id="<%= item._id %>">+</button>
          </div>

          <!-- Remove -->
          <button class="removeBtn ml-4 text-gray-400 hover:text-red-500" data-id="<%= item._id %>">
            âœ•
          </button>
        </div>
      <% }) %>
      <% } else { %>

      <!-- Empty Cart View -->
      <div class="flex justify-center items-center w-full">
        <div class="bg-gray-100 rounded-lg p-10 w-full text-center max-w-2xl">
          <div class="flex justify-center mb-4">
            <dotlottie-wc
              src="https://lottie.host/b8525566-0f9b-4521-9e54-b67a83f04cf8/ACQNbvFZhH.lottie"
              style="width: 300px; height: 300px"
              autoplay
              loop
            ></dotlottie-wc>
          </div>
          <h2 class="text-lg font-semibold mb-2">Your cart is empty</h2>
          <p class="text-gray-600 mb-6">Looks like you haven't added anything yet.</p>
          <a href="/products" class="inline-block bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">
            Continue Shopping
          </a>
        </div>
      </div>

      <% } %>
    </div>

    <!-- Order Summary -->
    <% if(cartItems && cartItems.length > 0) { %>
    <div id="order-summary" class="border rounded-lg p-6 h-fit">
      <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>Subtotal</span>
          <span id="subtotal">â‚¹ <%= subtotal %></span>
        </div>
        <div class="flex justify-between">
          <span>Shipping</span>
          <span class="text-green-600 font-medium">Free</span>
        </div>
        <div class="flex justify-between">
          <span>Tax</span>
          <span id="tax">â‚¹ <%= tax %></span>
        </div>
      </div>
      <div class="border-t mt-4 pt-4 flex justify-between font-bold">
        <span>Total</span>
        <span id="total">â‚¹ <%= total %></span>
      </div>

      <button id="checkoutBtn" class="w-full mt-6 bg-black text-white py-3 rounded hover:bg-gray-800">
        Checkout
      </button>
      <a href="/products" class="block mt-3 text-center text-sm text-gray-500 hover:underline">
        Continue Shopping
      </a>
    </div>
    <% } %>
  </div>
</div>

<!-- Remove Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-80 text-center">
    <h2 class="text-lg font-semibold mb-4">Remove Item</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to remove this product from your cart?</p>
    <div class="flex justify-center space-x-4">
      <button id="cancelRemove" class="px-4 py-2 border rounded hover:bg-gray-100">No</button>
      <button id="confirmRemove" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes</button>
    </div>
  </div>
</div>

<!-- Toast Styles -->
<style>
  #toast-container > .toast-warning {
    background-color: #000000 !important;
    color: #ffffff !important;
    font-weight: 600;
    border: 1px solid #333333;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  #toast-container > .toast-warning .toast-close-button {
    color: #ffffff !important;
    font-weight: 700;
    opacity: 1 !important;
  }
</style>

<!-- Scripts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  // âœ… All your JS logic stays the same (no discounted_price logic used)
  toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-bottom-right",
    timeOut: "2000",
  };

  document.addEventListener("DOMContentLoaded", () => {
    let itemToRemove = null;

    // ðŸ”¹ Helper to update the badge in header
    function updateCartBadge(cartLength) {
      const badge = document.getElementById("cartText");
      if (!badge) return;
      if (cartLength && cartLength !== 0) {
        badge.textContent = cartLength;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }

    // ðŸ”¹ Increase quantity
    document.querySelectorAll(".increaseBtn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const itemId = btn.dataset.id;
        const res = await fetch(`/cart/${itemId}/increase`, { method: "PATCH" });
        const data = await res.json();

        if (data.success) {
          document.getElementById(`qty-${itemId}`).innerHTML = data.newQty;
          updateSummary(data.summary);
          updateCartBadge(data.cartLength);
          if (data.message) toastr.info(data.message);
        } else {
          toastr.warning(data.message);
          if (data.newQty !== undefined) {
            document.getElementById(`qty-${itemId}`).innerHTML = data.newQty;
            updateSummary(data.summary);
            updateCartBadge(data.cartLength);
          }
        }
      });
    });

    // ðŸ”¹ Decrease quantity
    document.querySelectorAll(".decreaseBtn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const itemId = btn.dataset.id;
        const res = await fetch(`/cart/${itemId}/decrease`, { method: "PATCH" });
        const data = await res.json();

        if (data.success) {
          if (data.removed) {
            document.getElementById(`item-${itemId}`).remove();
            toastr.info("Item removed from cart");
          } else {
            document.getElementById(`qty-${itemId}`).innerHTML = data.newQty;
          }
          updateSummary(data.summary);
          updateCartBadge(data.cartLength);
          if (data.message) toastr.info(data.message);

          if (data.summary.subtotal === 0) {
            showEmptyCart();
          }
        } else {
          toastr.warning(data.message);
          if (data.newQty !== undefined) {
            document.getElementById(`qty-${itemId}`).innerHTML = data.newQty;
            updateSummary(data.summary);
            updateCartBadge(data.cartLength);
          }
        }
      });
    });

    // ðŸ”¹ Remove button click â†’ show modal
    document.querySelectorAll(".removeBtn").forEach((btn) => {
      btn.addEventListener("click", () => {
        itemToRemove = btn.dataset.id;
        document.getElementById("confirmModal").classList.remove("hidden");
        document.getElementById("confirmModal").classList.add("flex");
      });
    });

    // ðŸ”¹ Cancel modal
    document.getElementById("cancelRemove").addEventListener("click", () => {
      itemToRemove = null;
      document.getElementById("confirmModal").classList.add("hidden");
      document.getElementById("confirmModal").classList.remove("flex");
    });

    // ðŸ”¹ Confirm remove
    document
      .getElementById("confirmRemove")
      .addEventListener("click", async () => {
        if (!itemToRemove) return;

        const res = await fetch(`/cart/${itemToRemove}`, {
          method: "DELETE",
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById(`item-${itemToRemove}`).remove();
          updateSummary(data.summary);
          updateCartBadge(data.cartLength); // âœ… update badge
          toastr.error("Item removed from cart");

          if (data.summary.subtotal === 0) {
            showEmptyCart();
          }
        } else {
          toastr.warning(data.message);
        }

        itemToRemove = null;
        document.getElementById("confirmModal").classList.add("hidden");
        document.getElementById("confirmModal").classList.remove("flex");
      });

    // ðŸ”¹ Update totals
    function updateSummary(summary) {
      document.getElementById("subtotal").innerText = `â‚¹ ${summary.subtotal}`;
      document.getElementById("tax").innerText = `â‚¹ ${summary.tax}`;
      document.getElementById("total").innerText = `â‚¹ ${summary.total}`;
    }

    // ðŸ”¹ Show empty cart template
    function showEmptyCart() {
      const cartItems = document.getElementById("cart-items");
      if (cartItems) {
        cartItems.outerHTML = `
  <div class="col-span-1" id="cart-items">
    <div class="flex justify-center items-center w-full">
      <div class="bg-gray-100 rounded-lg p-10 w-full text-center max-w-2xl">
        <div class="flex justify-center mb-4">
          <dotlottie-wc 
            src="https://lottie.host/b8525566-0f9b-4521-9e54-b67a83f04cf8/ACQNbvFZhH.lottie" 
            style="width: 300px; height: 300px"
            autoplay
            loop>
          </dotlottie-wc>
        </div>
        <h2 class="text-lg font-semibold mb-2">Your cart is empty</h2>
        <p class="text-gray-600 mb-6">Looks like you haven't added anything yet.</p>
        <a href="/products" 
           class="inline-block bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">
          Continue Shopping
        </a>
      </div>
    </div>
  </div>`;
      }

      const orderSummary = document.getElementById("order-summary");
      if (orderSummary) {
        orderSummary.remove();
      }

      const grid = document.querySelector(".grid");
      if (grid) {
        grid.classList.remove("lg:grid-cols-3");
        grid.classList.add("grid-cols-1");
      }

      // âœ… Also hide the cart badge when empty
      updateCartBadge(0);
    }
  });

  // ðŸ”¹ Checkout button â†’ go to checkout page
  const checkoutBtn = document.getElementById("checkoutBtn");
  if (checkoutBtn) {
    checkoutBtn.addEventListener("click", () => {
      window.location.href = "/checkout";
    });
  }

  <% if (error === 'stock') { %>
    toastr.error('Some items are completely out of stock and were removed.');
  <% } else if (error === 'stockUpdate') { %>
      <% const safeProducts = typeof products !== 'undefined' && products ? decodeURIComponent(products) : ''; %>
      const productList = "<%= safeProducts %>";
      if (productList) {
        toastr.warning(`Stock updated for: ${productList}`);
    } else {
      toastr.warning('Some item quantities were updated due to stock changes.');
    }
  <% } %>

</script>

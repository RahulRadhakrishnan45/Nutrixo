<div class="container mx-auto px-6 py-10">
  <!-- Breadcrumb with grey bg -->
  <div class="py-3 px-6 mb-10">
    <nav class="text-sm text-gray-500">
      <ol class="flex items-center space-x-2">
        <li><a href="/" class="hover:underline text-gray-600">Nutrixo</a></li>
        <li>/</li>
        <li class="text-gray-800 font-medium">Cart</li>
      </ol>
    </nav>
  </div>

  <h1 class="text-2xl font-bold mb-6">Your cart</h1>

  <!-- Dynamic grid: 3 cols if items, 1 col if empty -->
  <div class="grid <%= cartItems && cartItems.length > 0 ? 'grid-cols-1 lg:grid-cols-3' : 'grid-cols-1' %> gap-10">
    
    <!-- Cart Items -->
    <div class="<%= cartItems && cartItems.length > 0 ? 'lg:col-span-2 space-y-6' : 'col-span-1' %>" id="cart-items">
      <% if(cartItems && cartItems.length > 0) { %>
        <% cartItems.forEach(item => { %>
          <div id="item-<%= item._id %>" class="flex items-center border-b pb-4">
            <!-- Product Image -->
            <img src="<%= item.variant.images[0] || '/images/no-image.png' %>"
                 alt="<%= item.product.title %>"
                 class="w-20 h-20 object-contain rounded border mr-4">
            
            <!-- Product Details -->
            <div class="flex-1">
              <h2 class="text-lg font-semibold"><%= item.product.title %></h2>
              <p class="text-sm text-gray-600">
                <%= item.variant.flavour %> Flavour — Quantity: <%= item.variant.size %>
              </p>
              <p class="text-gray-800 font-bold mt-1">
                ₹ <%= item.variant.discounted_price || item.variant.price %>
              </p>
            </div>

            <!-- Quantity Controls -->
            <div class="flex items-center space-x-2">
              <button class="decreaseBtn px-2 py-1 border rounded" data-id="<%= item._id %>">−</button>
              <span id="qty-<%= item._id %>"><%= item.quantity %></span>
              <button class="increaseBtn px-2 py-1 border rounded" data-id="<%= item._id %>">+</button>
            </div>

            <!-- Remove -->
            <button class="removeBtn ml-4 text-gray-400 hover:text-red-500" data-id="<%= item._id %>">✕</button>
          </div>
        <% }) %>
      <% } else { %>
        <!-- Empty Cart View -->
        <div class="flex justify-center items-center w-full">
          <div class="bg-gray-100 rounded-lg p-10 w-full text-center max-w-2xl">
            <div class="flex justify-center mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7a1 1 0 00.9 1.45h12.1M7 13l1.35-2.7a1 1 0 01.9-.55h8.3a1 1 0 01.9.55L21 13M7 21a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2z" />
              </svg>
            </div>
            <h2 class="text-lg font-semibold mb-2">Your cart is empty</h2>
            <p class="text-gray-600 mb-6">Looks like you haven't added anything yet.</p>
            <a href="/products"
               class="inline-block bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">
              Continue Shopping
            </a>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Order Summary (only if items exist) -->
    <% if(cartItems && cartItems.length > 0) { %>
      <div id="order-summary" class="border rounded-lg p-6 h-fit">
        <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Subtotal</span>
            <span id="subtotal">₹ <%= subtotal %></span>
          </div>
          <div class="flex justify-between">
            <span>Shipping</span>
            <span class="text-green-600 font-medium">Free</span>
          </div>
          <div class="flex justify-between">
            <span>Tax</span>
            <span id="tax">₹ <%= tax %></span>
          </div>
        </div>
        <div class="border-t mt-4 pt-4 flex justify-between font-bold">
          <span>Total</span>
          <span id="total">₹ <%= total %></span>
        </div>

        <button id="checkoutBtn" class="w-full mt-6 bg-black text-white py-3 rounded hover:bg-gray-800">
          Checkout
        </button>
        <a href="/products" class="block mt-3 text-center text-sm text-gray-500 hover:underline">
          Continue Shopping
        </a>
      </div>
    <% } %>

  </div>
</div>

<!-- Remove Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-80 text-center">
    <h2 class="text-lg font-semibold mb-4">Remove Item</h2>
    <p class="text-gray-600 mb-6">Are you sure you want to remove this product from your cart?</p>
    <div class="flex justify-center space-x-4">
      <button id="cancelRemove" class="px-4 py-2 border rounded hover:bg-gray-100">No</button>
      <button id="confirmRemove" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes</button>
    </div>
  </div>
</div>

<style>
  
  #toast-container > .toast-warning {
    background-color: #000000 !important; 
    color: #ffffff !important;            
    font-weight: 600;                     
    border: 1px solid #333333;            
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  #toast-container > .toast-warning .toast-close-button {
    color: #ffffff !important;
    font-weight: 700;
    opacity: 1 !important;
  }
</style>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
toastr.options = {
  closeButton: true,
  progressBar: true,
  positionClass: "toast-bottom-right",
  timeOut: "2000"
}

document.addEventListener('DOMContentLoaded', () => {
  let itemToRemove = null

  document.querySelectorAll('.increaseBtn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const itemId = btn.dataset.id
      const res = await fetch(`/cart/increase/${itemId}`, { method:'POST' })
      const data = await res.json()
      
      if(data.success) {
        document.getElementById(`qty-${itemId}`).innerHTML = data.newQty
        updateSummary(data.summary)
      } else {
        const msg = typeof data.message === 'string' ? data.message : 'Max 5 quantity allowed'
        toastr.warning(msg)
      }
    })
  })

  document.querySelectorAll('.decreaseBtn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const itemId = btn.dataset.id
      const res = await fetch(`/cart/decrease/${itemId}`, { method:'POST' })
      const data = await res.json()
      if(data.success) {
        if(data.removed) {
          document.getElementById(`item-${itemId}`).remove()
          toastr.info('Item removed from cart')
        } else {
          document.getElementById(`qty-${itemId}`).innerHTML = data.newQty
        }
        updateSummary(data.summary)

        if(data.summary.subtotal === 0) {
          showEmptyCart()
        }
      } else {
        toastr.warning(data.message)
      }
    })
  })

  document.querySelectorAll('.removeBtn').forEach((btn) => {
    btn.addEventListener('click', () => {
      itemToRemove = btn.dataset.id; // save the item ID
      document.getElementById('confirmModal').classList.remove('hidden')
      document.getElementById('confirmModal').classList.add('flex')
    })
  })

  
  document.getElementById('cancelRemove').addEventListener('click', () => {
    itemToRemove = null
    document.getElementById('confirmModal').classList.add('hidden')
    document.getElementById('confirmModal').classList.remove('flex')
  })

  
  document.getElementById('confirmRemove').addEventListener('click', async () => {
    if (!itemToRemove) return

    const res = await fetch(`/cart/remove/${itemToRemove}`, { method:'POST' })
    const data = await res.json()

    if (data.success) {
      document.getElementById(`item-${itemToRemove}`).remove()
      updateSummary(data.summary)
      toastr.error('Item removed from cart')

      if (data.summary.subtotal === 0) {
        showEmptyCart()
      }
    } else {
      toastr.warning(data.message)
    }

    itemToRemove = null
    document.getElementById('confirmModal').classList.add('hidden')
    document.getElementById('confirmModal').classList.remove('flex')
  })

  function updateSummary(summary) {
    document.getElementById('subtotal').innerText = `₹ ${summary.subtotal}`
    document.getElementById("tax").innerText = `₹ ${summary.tax}`
    document.getElementById("total").innerText = `₹ ${summary.total}`
  }

  function showEmptyCart() {
    const cartItems = document.getElementById("cart-items");
    if (cartItems) {
      cartItems.outerHTML = `
        <div class="col-span-1" id="cart-items">
          <div class="flex justify-center items-center w-full">
            <div class="bg-gray-100 rounded-lg p-10 w-full text-center max-w-2xl">
              <div class="flex justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7a1 1 0 00.9 1.45h12.1M7 13l1.35-2.7a1 1 0 01.9-.55h8.3a1 1 0 01.9.55L21 13M7 21a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2z" />
                </svg>
              </div>
              <h2 class="text-lg font-semibold mb-2">Your cart is empty</h2>
              <p class="text-gray-600 mb-6">Looks like you haven't added anything yet.</p>
              <a href="/products" 
                 class="inline-block bg-black text-white px-6 py-2 rounded hover:bg-gray-800 transition">
                Continue Shopping
              </a>
            </div>
          </div>
        </div>`;
    }

    const orderSummary = document.getElementById("order-summary");
    if (orderSummary) {
      orderSummary.remove();
    }

    const grid = document.querySelector(".grid");
    if (grid) {
      grid.classList.remove("lg:grid-cols-3");
      grid.classList.add("grid-cols-1");
    }
  }
})
</script>


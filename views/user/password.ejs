<!-- Page Title and Breadcrumb -->
<div class="bg-gray-100 py-7 px-4">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-xl font-bold mb-2">
      <%= isGoogleUser ? 'Create Password' : 'Change Password' %>
    </h1>
    <nav class="text-sm text-gray-600">
      <a href="/" class="hover:underline font-medium">Nutrixo</a>
      <span>/</span>
      <span><%= isGoogleUser ? 'Create Password' : 'Change Password' %></span>
    </nav>
  </div>
</div>

<!-- Change/Create Password Form -->
<div class="flex items-center justify-center py-20">
  <form
    id="changePasswordForm"
    action="/password"
    method="POST"
    class="w-full max-w-md bg-white shadow-lg rounded-xl px-8 py-10"
  >
    <% if (!isGoogleUser) { %>
    <!-- Current Password -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Current password
      </label>
      <input
        type="password"
        name="currentPassword"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="Enter your current password"
      />
    </div>
    <% } %>

    <!-- New Password -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        New password
      </label>
      <input
        type="password"
        name="newPassword"
        id="newPassword"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="Enter your new password"
      />
      <p id="errorNewPass" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>

    <!-- Confirm Password -->
    <div class="mb-8">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Confirm password
      </label>
      <input
        type="password"
        name="confirmPassword"
        id="confirmPassword"
        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="Re-enter your new password"
      />
      <p id="errorConfirmPass" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="w-full bg-gray-900 text-white font-medium py-2.5 rounded-lg hover:bg-gray-800 transition"
    >
      <%= isGoogleUser ? 'Create Password' : 'Change Password' %>
    </button>
  </form>
</div>

<!-- ✅ Toastr Imports -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- ✅ Toastr Styling (black + bottom-right like cart) -->
<style>
  #toast-container > div {
    background-color: #000000 !important;
    color: #ffffff !important;
    font-weight: 600;
    border: 1px solid #333333;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    font-size: 15px;
    padding:  14px 20px 14px 44px !important;
    position: relative;
  }

  #toast-container > div > .toast-close-button {
    color: #ffffff !important;
    font-weight: 700;
    opacity: 1 !important;
  }
</style>

<script>
  // ✅ Toastr Configuration
  toastr.options = {
    closeButton: true,
    progressBar: true,
    positionClass: "toast-bottom-right",
    timeOut: "2000",
  };

  const form = document.getElementById("changePasswordForm");
  const newPass = document.getElementById("newPassword");
  const confirmPass = document.getElementById("confirmPassword");
  const errorNewPass = document.getElementById("errorNewPass");
  const errorConfirmPass = document.getElementById("errorConfirmPass");

  // ✅ Password Validation
  function validatePasswords() {
    const passVal = newPass.value.trim();
    const confirmVal = confirmPass.value.trim();
    const passPattern =
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

    let isValid = true;

    if (passVal === "") {
      errorNewPass.textContent = "Password cannot be empty";
      errorNewPass.classList.remove("hidden");
      isValid = false;
    } else if (!passPattern.test(passVal)) {
      errorNewPass.textContent =
        "Password must be at least 8 characters and include uppercase, lowercase, number, and special character";
      errorNewPass.classList.remove("hidden");
      isValid = false;
    } else {
      errorNewPass.classList.add("hidden");
    }

    if (confirmVal === "") {
      errorConfirmPass.textContent = "Please confirm your password";
      errorConfirmPass.classList.remove("hidden");
      isValid = false;
    } else if (confirmVal !== passVal) {
      errorConfirmPass.textContent = "Passwords do not match";
      errorConfirmPass.classList.remove("hidden");
      isValid = false;
    } else {
      errorConfirmPass.classList.add("hidden");
    }

    return isValid;
  }

  newPass.addEventListener("input", validatePasswords);
  confirmPass.addEventListener("input", validatePasswords);

  // ✅ Form Submit (Toastr Feedback)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!validatePasswords()) return;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch("/password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await res.json();

      if (result.success) {
        toastr.info(result.message || "Password updated successfully!");
        setTimeout(() => {
          window.location.href = result.redirect || "/password";
        }, 1500);
      } else {
        toastr.warning(result.message || "Something went wrong!");
      }
    } catch (error) {
      toastr.warning("Something went wrong. Please try again later.");
    }
  });
</script>
